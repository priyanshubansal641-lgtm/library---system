<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Library Seat Management</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Poppins', sans-serif; background: #f0f4f8; min-height: 100vh; color: #2d3748; }

  .header {
    background: linear-gradient(135deg, #1a56db, #1e429f);
    color: white;
    padding: 16px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 2px 10px rgba(0,0,0,0.15);
  }
  .header-left h1 { font-size: 1.4rem; font-weight: 700; }
  .header-left p { font-size: 0.8rem; opacity: 0.8; margin-top: 2px; }
  .clock { font-size: 2.2rem; font-weight: 700; letter-spacing: 2px; line-height: 1; text-align:center; }
  .date { font-size: 0.75rem; opacity: 0.8; margin-top: 4px; text-align:center; }
  .stats-box { display: flex; gap: 16px; }
  .stat { background: rgba(255,255,255,0.15); border-radius: 12px; padding: 10px 20px; text-align: center; min-width: 90px; }
  .stat-num { font-size: 1.8rem; font-weight: 700; line-height: 1; }
  .stat-num.green { color: #6ee7b7; }
  .stat-num.red { color: #fca5a5; }
  .stat-label { font-size: 0.65rem; opacity: 0.85; text-transform: uppercase; letter-spacing: 1px; margin-top: 2px; }

  .main { display: flex; height: calc(100vh - 75px); }

  .left-panel {
    width: 290px; min-width: 290px;
    background: white;
    border-right: 1px solid #e2e8f0;
    display: flex; flex-direction: column;
    padding: 20px; gap: 14px;
    overflow-y: auto;
    box-shadow: 2px 0 8px rgba(0,0,0,0.05);
  }

  .panel-title { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1.5px; color: #718096; }

  .camera-wrapper {
    width: 100%; height: 155px;
    border-radius: 12px; overflow: hidden;
    position: relative; background: #1a202c;
    border: 2px solid #e2e8f0;
  }
  #camera-view { width: 100%; height: 100%; object-fit: cover; }
  .scan-line {
    position: absolute; left: 15%; right: 15%;
    height: 2px; background: rgba(26,86,219,0.9);
    box-shadow: 0 0 8px rgba(26,86,219,0.9);
    animation: scanAnim 2s ease-in-out infinite;
  }
  @keyframes scanAnim { 0%,100% { top: 25%; } 50% { top: 75%; } }
  .camera-label { font-size: 0.65rem; color: #a0aec0; text-align: center; }

  .divider { display: flex; align-items: center; gap: 8px; color: #a0aec0; font-size: 0.75rem; }
  .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: #e2e8f0; }

  .scan-input {
    width: 100%; padding: 12px 16px;
    border: 2px solid #e2e8f0; border-radius: 10px;
    font-family: 'Poppins', sans-serif; font-size: 0.9rem;
    outline: none; transition: all 0.2s;
    background: #f7fafc; color: #2d3748; text-align: center;
  }
  .scan-input:focus { border-color: #1a56db; background: white; box-shadow: 0 0 0 3px rgba(26,86,219,0.1); }
  .scan-input::placeholder { color: #a0aec0; font-size: 0.8rem; }
  .input-hint { font-size: 0.62rem; color: #a0aec0; text-align: center; }
  .small-link { display: block; text-align: center; margin-top: 8px; color: #1a56db; font-size: 0.85rem; text-decoration: none; font-weight: 600; }
  .small-link:hover { text-decoration: underline; }

  .student-card {
    background: #ebf8ff; border: 1.5px solid #bee3f8;
    border-radius: 12px; padding: 14px;
    display: none; animation: fadeIn 0.3s ease;
  }
  .student-card.show { display: block; }
  .student-card.exit-mode { background: #fff5f5; border-color: #fed7d7; }
  @keyframes fadeIn { from { opacity:0; transform:translateY(-8px); } to { opacity:1; transform:translateY(0); } }
  .student-name { font-size: 1.1rem; font-weight: 700; color: #1a56db; margin-bottom: 3px; }
  .student-card.exit-mode .student-name { color: #e53e3e; }
  .student-roll { font-size: 0.72rem; color: #718096; margin-bottom: 6px; }
  .student-status { font-size: 0.78rem; font-weight: 500; color: #2d3748; }

  .confirm-btn {
    display: none; width: 100%; padding: 13px;
    background: #1a56db; color: white; border: none;
    border-radius: 10px; font-family: 'Poppins', sans-serif;
    font-size: 0.9rem; font-weight: 600; cursor: pointer;
    transition: all 0.2s;
  }
  .confirm-btn:hover { background: #1e429f; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(26,86,219,0.3); }
  .confirm-btn.show { display: block; animation: fadeIn 0.3s ease; }

  .legend { margin-top: auto; padding-top: 14px; border-top: 1px solid #e2e8f0; }
  .legend-title { font-size: 0.65rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: #a0aec0; margin-bottom: 10px; }
  .legend-items { display: flex; flex-direction: column; gap: 8px; }
  .legend-item { display: flex; align-items: center; gap: 10px; font-size: 0.8rem; color: #4a5568; }
  .legend-dot { width: 16px; height: 16px; border-radius: 4px; flex-shrink: 0; }
  .legend-dot.free { background: #48bb78; }
  .legend-dot.taken { background: #fc8181; }
  .legend-dot.selected { background: #1a56db; }

  .seat-area { flex: 1; overflow-y: auto; padding: 20px 24px; }
  .seat-area::-webkit-scrollbar { width: 5px; }
  .seat-area::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 3px; }

  .section-header {
    font-size: 0.72rem; font-weight: 600;
    text-transform: uppercase; letter-spacing: 1.5px;
    color: #718096; margin-bottom: 10px; margin-top: 20px;
    display: flex; align-items: center; gap: 10px;
  }
  .section-header::after { content: ''; flex: 1; height: 1px; background: #e2e8f0; }

  .seat-grid { display: grid; grid-template-columns: repeat(20, 1fr); gap: 5px; margin-bottom: 6px; }

  .seat {
    aspect-ratio: 1; border-radius: 5px;
    background: #c6f6d5; border: 1.5px solid #9ae6b4;
    cursor: pointer; transition: all 0.15s;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.4rem; font-weight: 600; color: #276749;
  }
  .seat:hover:not(.occupied) { background: #9ae6b4; border-color: #48bb78; transform: scale(1.2); z-index: 5; box-shadow: 0 2px 8px rgba(72,187,120,0.4); }
  .seat.occupied { background: #fed7d7; border-color: #fc8181; color: #c53030; cursor: not-allowed; }
  .seat.selected-seat { background: #1a56db; border-color: #1e429f; color: white; transform: scale(1.15); box-shadow: 0 2px 10px rgba(26,86,219,0.5); animation: seatPulse 1.5s infinite; }
  @keyframes seatPulse { 0%,100% { box-shadow: 0 2px 8px rgba(26,86,219,0.4); } 50% { box-shadow: 0 4px 16px rgba(26,86,219,0.7); } }

  .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 999; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(3px); }
  .overlay.show { opacity: 1; }

  .toast {
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0.85);
    background: white; border-radius: 20px;
    padding: 40px 50px; text-align: center;
    z-index: 1000; opacity: 0;
    transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
    min-width: 360px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    border-top: 5px solid #48bb78;
    pointer-events: none;
  }
  .toast.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
  .toast.exit-toast { border-top-color: #1a56db; }
  .toast-icon { font-size: 3.5rem; margin-bottom: 12px; }
  .toast-title { font-size: 1.5rem; font-weight: 700; color: #2d3748; margin-bottom: 8px; }
  .toast-msg { font-size: 1rem; color: #718096; }
  .toast-seat { font-size: 0.85rem; color: #a0aec0; margin-top: 8px; font-weight: 500; }
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <h1>üìö Library Seat Management</h1>
    <p>Scan your ID card to book a seat</p>
  </div>
  <div>
    <div class="clock" id="clock">--:--:--</div>
    <div class="date" id="date">--</div>
  </div>
  <div class="stats-box">
    <div class="stat">
      <div class="stat-num green" id="avail-count">400</div>
      <div class="stat-label">Available</div>
    </div>
    <div class="stat">
      <div class="stat-num red" id="occ-count">0</div>
      <div class="stat-label">Occupied</div>
    </div>
  </div>
</div>

<div class="main">
  <div class="left-panel">
    <div class="panel-title">üîç Scan ID Card</div>
    <div class="camera-wrapper">
      <video id="camera-view" autoplay playsinline muted></video>
      <div class="scan-line"></div>
    </div>
    <div class="camera-label">Show barcode in front of camera</div>
    <div class="divider">OR</div>
    <input type="text" id="barcode-input" class="scan-input" placeholder="Scan or type ID number..." autofocus autocomplete="off"/>
    <a href="student-view.html" class="small-link">Open Student View</a>
    <div class="input-hint">‚ö° External scanner will auto-submit</div>
    <div class="student-card" id="student-card">
      <div class="student-name" id="student-name">‚Äî</div>
      <div class="student-roll" id="student-id">ID: ‚Äî</div>
      <div class="student-status" id="student-status">‚Äî</div>
    </div>
    <button class="confirm-btn" id="confirm-btn" onclick="confirmSeat()">‚úÖ Confirm Seat</button>
    <div class="legend">
      <div class="legend-title">Legend</div>
      <div class="legend-items">
        <div class="legend-item"><div class="legend-dot free"></div> Available</div>
        <div class="legend-item"><div class="legend-dot taken"></div> Occupied</div>
        <div class="legend-item"><div class="legend-dot selected"></div> Your Selection</div>
      </div>
    </div>
  </div>

  <div class="seat-area">
    <div class="section-header">Section A ‚Äî Seats 1 to 200</div>
    <div class="seat-grid" id="grid-A"></div>
    <div class="section-header">Section B ‚Äî Seats 1 to 200</div>
    <div class="seat-grid" id="grid-B"></div>
  </div>
</div>

<div class="overlay" id="overlay"></div>
<div class="toast" id="toast">
  <div class="toast-icon" id="toast-icon">‚úÖ</div>
  <div class="toast-title" id="toast-title">Seat Confirmed!</div>
  <div class="toast-msg" id="toast-msg">Enjoy your study session</div>
  <div class="toast-seat" id="toast-seat"></div>
</div>

<script>
const socket = io('http://localhost:3000');
let currentStudent = null, selectedSeat = null, seats = {};

function buildGrid() {
  ['A','B'].forEach(sec => {
    const grid = document.getElementById(`grid-${sec}`);
    for (let i = 1; i <= 200; i++) {
      seats[`${sec}${i}`] = { occupied: false, studentId: null };
      grid.appendChild(createSeatEl(`${sec}${i}`));
    }
  });
}

function createSeatEl(id) {
  const el = document.createElement('div');
  el.className = 'seat';
  el.id = `seat-${id}`;
  el.title = `Seat ${id}`;
  el.textContent = id.replace(/[AB]/, '');
  el.addEventListener('click', () => selectSeat(id));
  return el;
}

socket.on('all-seats', (data) => { seats = data; Object.keys(seats).forEach(updateSeatUI); updateCounts(); });
socket.on('seat-update', (data) => { seats[data.seatId] = { occupied: data.occupied, studentId: data.studentId }; updateSeatUI(data.seatId); updateCounts(); });
socket.on('student-verified', (data) => { currentStudent = data.student; showStudentCard(data.student, data.isInside); });
socket.on('error-msg', (data) => { alert(data.msg); });

const barcodeInput = document.getElementById('barcode-input');
barcodeInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    const code = barcodeInput.value.trim();
    if (code) { socket.emit('verify-student', { barcode: code }); barcodeInput.value = ''; }
  }
});
setInterval(() => barcodeInput.focus(), 2000);

async function startCamera() {
  try {
    const devices = await navigator.mediaDevices.enumerateDevices();
    const videoDevices = devices.filter(d => d.kind === 'videoinput');
    const deviceId = videoDevices[videoDevices.length - 1].deviceId;
    const stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: deviceId } } });
    document.getElementById('camera-view').srcObject = stream;
    Quagga.init({ inputStream: { type: 'LiveStream', target: document.getElementById('camera-view'), constraints: { deviceId: { exact: deviceId } } }, decoder: { readers: ['code_128_reader','ean_reader','ean_8_reader','code_39_reader'] }, locate: true }, (err) => { if (!err) Quagga.start(); });
    let lastCode = '', lastTime = 0;
    Quagga.onDetected((result) => {
      const code = result.codeResult.code, now = Date.now();
      if (code !== lastCode || now - lastTime > 3000) { lastCode = code; lastTime = now; socket.emit('verify-student', { barcode: code }); }
    });
  } catch(err) { console.log('Camera error:', err); }
}

function showStudentCard(student, isInside) {
  const card = document.getElementById('student-card');
  document.getElementById('student-name').textContent = student.name;
  document.getElementById('student-id').textContent = `Roll No: ${student.roll_number}`;
  card.classList.add('show');
  if (isInside) {
    card.classList.add('exit-mode');
    document.getElementById('student-status').textContent = 'üö™ Exiting ‚Äî Releasing your seat...';
    document.getElementById('confirm-btn').classList.remove('show');
    socket.emit('student-exit', { studentId: student.id });
    showToast('exit', student.name, student.seat_id);
    setTimeout(resetUI, 3500);
  } else {
    card.classList.remove('exit-mode');
    document.getElementById('student-status').textContent = 'üëá Please select a seat from the map';
    document.getElementById('confirm-btn').classList.remove('show');
    selectedSeat = null; clearSelectedUI();
  }
}

function selectSeat(id) {
  if (!currentStudent) { alert('Please scan your ID card first!'); return; }
  if (seats[id].occupied) return;
  clearSelectedUI(); selectedSeat = id;
  document.getElementById(`seat-${id}`).classList.add('selected-seat');
  const btn = document.getElementById('confirm-btn');
  btn.textContent = `‚úÖ Confirm Seat ${id}`; btn.classList.add('show');
  document.getElementById('student-status').textContent = `ü™ë Selected: Seat ${id}`;
}

function clearSelectedUI() { document.querySelectorAll('.seat.selected-seat').forEach(el => el.classList.remove('selected-seat')); }

function confirmSeat() {
  if (!currentStudent || !selectedSeat) return;
  socket.emit('book-seat', { studentId: currentStudent.id, seatId: selectedSeat });
  showToast('enter', currentStudent.name, selectedSeat);
  setTimeout(resetUI, 3500);
}

function resetUI() {
  currentStudent = null; selectedSeat = null;
  document.getElementById('student-card').classList.remove('show','exit-mode');
  document.getElementById('confirm-btn').classList.remove('show');
  clearSelectedUI(); hideToast();
}

function updateSeatUI(id) {
  const el = document.getElementById(`seat-${id}`);
  if (!el) return;
  if (seats[id].occupied) { el.classList.add('occupied'); el.classList.remove('selected-seat'); }
  else { el.classList.remove('occupied'); }
}

function updateCounts() {
  const occ = Object.values(seats).filter(s => s.occupied).length;
  document.getElementById('avail-count').textContent = 400 - occ;
  document.getElementById('occ-count').textContent = occ;
}

function showToast(type, name, seatId) {
  const toast = document.getElementById('toast');
  if (type === 'enter') {
    document.getElementById('toast-icon').textContent = '‚úÖ';
    document.getElementById('toast-title').textContent = 'Seat Confirmed!';
    document.getElementById('toast-msg').textContent = `Welcome, ${name}! Enjoy your study session.`;
    document.getElementById('toast-seat').textContent = `Your Seat: ${seatId}`;
    toast.classList.remove('exit-toast');
  } else {
    document.getElementById('toast-icon').textContent = 'üëã';
    document.getElementById('toast-title').textContent = 'Thank You!';
    document.getElementById('toast-msg').textContent = `Goodbye, ${name}! See you next time.`;
    document.getElementById('toast-seat').textContent = seatId ? `Seat ${seatId} released` : '';
    toast.classList.add('exit-toast');
  }
  toast.classList.add('show');
  document.getElementById('overlay').classList.add('show');
}

function hideToast() {
  document.getElementById('toast').classList.remove('show');
  document.getElementById('overlay').classList.remove('show');
}

function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
  document.getElementById('date').textContent = now.toLocaleDateString('en-IN', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
}

buildGrid(); startCamera(); updateClock(); setInterval(updateClock, 1000);
</script>
</body>
</html>